import yfinance as yf
import openai
import pandas as pd
import streamlit as st

# OpenAI API Key
openai.api_key = "your_openai_api_key"  # Replace with your OpenAI API Key

# Function to fetch data from Yahoo Finance
@st.cache
def fetch_data(ticker: str, period: str = "1y") -> pd.DataFrame:
    stock = yf.Ticker(ticker)
    data = stock.history(period=period)
    data.reset_index(inplace=True)
    return data

# Function to generate financial insights using OpenAI
def generate_insights(data: pd.DataFrame, ticker: str) -> str:
    prompt = f"""
    You are a financial expert. Analyze the historical data for the stock {ticker}.
    Provide insights on trends, key indicators, and suggest investment strategies.

    Data:
    {data[['Date', 'Close']].to_string(index=False)}

    Provide your detailed analysis.
    """
    response = openai.Completion.create(
        engine="text-davinci-003",
        prompt=prompt,
        max_tokens=500,
        temperature=0.7
    )
    return response.choices[0].text.strip()

# Streamlit Application
st.title("AI-Powered Financial Analysis Dashboard")

# Sidebar inputs
st.sidebar.header("Settings")
ticker = st.sidebar.text_input("Enter Stock Ticker (e.g., AAPL, TSLA)", "AAPL")
period = st.sidebar.selectbox("Select Time Period", ["1mo", "3mo", "6mo", "1y", "5y"])

# Fetch data
if st.sidebar.button("Fetch Data"):
    with st.spinner("Fetching data..."):
        try:
            data = fetch_data(ticker, period)
            st.success("Data fetched successfully!")

            # Display data
            st.write(f"### {ticker} Stock Data ({period})")
            st.dataframe(data)

            # Plot stock closing prices
            st.write("### Closing Price Trend")
            st.line_chart(data.set_index("Date")["Close"])

            # Generate and display AI insights
            st.write("### AI-Generated Insights")
            insights = generate_insights(data, ticker)
            st.write(insights)

        except Exception as e:
            st.error(f"Error fetching data: {e}")
